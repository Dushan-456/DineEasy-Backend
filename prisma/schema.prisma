// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
// PRISMA CLIENT CONFIG
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma" // Output folder for generated client
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // DB connection string from environment
}

// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
// ENUMS (Predefined sets of values)
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------

enum Role {
  CUSTOMER
  ADMIN
  DELIVERY
  STAFF 
}

enum ProductType {
  BOOK
  EBOOK
  STATIONERY
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ServiceType {
  PRINTING
  TYPING
  EDITING
  PHOTOCOPY
  OTHER
}

enum ServiceStatus {
  SUBMITTED
  IN_PROGRESS
  READY
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum DeliveryStatus {
     PENDING
      PROCESSING
      SHIPPED
      DELIVERED
      CANCELLED
      REFUNDED
}

// -----------------------------------------------------------------------------------------------------------------------------------------------------------
// MODELS (Database tables)
// -----------------------------------------------------------------------------------------------------------------------------------------------------------

// USERS table-----------------------------------------------------------------------------------------------------------------------------------------------
model User {
  id           String   @id @default(cuid()) // Unique user ID
  firstName    String
  lastName     String
  email        String   @unique // Unique email
  username     String   @unique // Unique username
  passwordHash String   // Hashed password
  role         Role     @default(CUSTOMER) // Default role = customer
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  passwordResetToken    String?     @unique
  passwordResetExpires  DateTime?

  // Relations
  Profile            Profile?
  carts              Cart[]
  orders             Order[]
  serviceOrders      ServiceOrder[]  
  deliveriesAssigned Delivery[]     @relation("DeliveryAssigned") // Deliveries assigned to user
  servicesAssigned   ServiceOrder[] @relation("ServiceAssigned")  // Services assigned to user
}

// USER PROFILE (optional details for user) -----------------------------------------------------------------------------------------------------------------------------------------------
model Profile {
  id          String    @id @default(cuid())
  image       String?
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String    @unique // One-to-one relation with User
  dob         DateTime?
  gender      String?
  designation String?
  mobile      String?
  address     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// PRODUCT CATEGORIES-----------------------------------------------------------------------------------------------------------------------------------------------
model Category {
  id       String     @id @default(cuid())
  name     String     @unique
  image    String?
  products Product[]  // One-to-many with Products
}

// PRODUCTS (Items in store) -----------------------------------------------------------------------------------------------------------------------------------------------
model Product {
  id          String      @id @default(cuid())
  title       String
  description String?
  price       Decimal     @db.Decimal(10, 2) // Standard price
  salePrice   Decimal?    @db.Decimal(10, 2) // Discounted price
  type        ProductType
  stock       Int         @default(0) // Inventory stock
  sku         String      @unique // Stock Keeping Unit
  isDigital   Boolean     @default(false) // For ebooks, etc.
  downloadUrl String?
  categoryId  String?
  images      ProductImage[] // Related images
  category    Category?   @relation(fields: [categoryId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  orderItems OrderItem[]
  cartItems  CartItem[]
}

// PRODUCT IMAGES (multiple per product)-----------------------------------------------------------------------------------------------------------------------------------------------
model ProductImage {
  id        String   @id @default(cuid())
  url       String
  altText   String?
  isPrimary Boolean  @default(false) // Main image
  productId String
  product   Product  @relation(fields: [productId], references: [id],onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// CART (one per user or guest)-----------------------------------------------------------------------------------------------------------------------------------------------
model Cart {
  id        String     @id @default(cuid())
  guestId   String?    @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  userId    String?    @unique
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

// CART ITEMS (products added to cart)-----------------------------------------------------------------------------------------------------------------------------------------------
model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)

  //  onDelete: Cascade to the relation
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

// ORDERS (placed by users)-----------------------------------------------------------------------------------------------------------------------------------------------
model Order {
  id              String        @id @default(cuid())
  userId          String
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  total           Decimal       @db.Decimal(10, 2)
  paymentProvider String?
  paymentIntentId String?
  shippingName    String?
  shippingPhone   String?
  shippingLine1   String?
  shippingLine2   String?
  shippingCity    String?
  shippingPostal  String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user     User        @relation(fields: [userId], references: [id],onDelete: Cascade)
  items    OrderItem[]
  delivery Delivery?
  payment  Payment?
}

// ORDER ITEMS (products in an order)-----------------------------------------------------------------------------------------------------------------------------------------------
model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id] ,onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

// PAYMENTS (can belong to an Order OR ServiceOrder)-----------------------------------------------------------------------------------------------------------------------------------------------
model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  provider      String
  status        PaymentStatus
  transactionId String?

  orderId        String? @unique
  order          Order?  @relation(fields: [orderId], references: [id] ,onDelete: Cascade)
  serviceOrderId String? @unique
  serviceOrder   ServiceOrder? @relation(fields: [serviceOrderId], references: [id])
}

// SERVICE ORDERS (like printing, typing, etc.)-----------------------------------------------------------------------------------------------------------------------------------------------
model ServiceOrder {
  id              String        @id @default(cuid())
  userId          String?       // Registered user
  guestName       String?       // Or guest name
  guestContact    String?       
  type            ServiceType
  details         String?         
  files           String[]        // File upload link
  status          ServiceStatus @default(SUBMITTED)
  price           Decimal       @default(0) @db.Decimal(10, 2)
  assignedStaffId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user          User?    @relation(fields: [userId], references: [id] ,onDelete: Cascade)
  assignedStaff User?    @relation("ServiceAssigned", fields: [assignedStaffId], references: [id])
  delivery      Delivery?
  payment       Payment?
}

// DELIVERIES (for Orders or ServiceOrders)-----------------------------------------------------------------------------------------------------------------------------------------------
model Delivery {
  id              String         @id @default(cuid())
  trackingCode    String         @unique // Tracking code
  status          DeliveryStatus @default(PENDING)
  assignedStaffId String?
  updatedAt       DateTime       @updatedAt
  createdAt       DateTime       @default(now())

  // Relations
  orderId        String? @unique
  serviceOrderId String? @unique
  order        Order?        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  serviceOrder ServiceOrder? @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  assignedTo   User?         @relation("DeliveryAssigned", fields: [assignedStaffId], references: [id])
}


